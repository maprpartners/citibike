wget https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-06-05/bin/linux/amd64/kubectl
chmod 755 kubectl
mv kubectl /usr/bin

wget https://amazon-eks.s3-us-west-2.amazonaws.com/1.10.3/2018-06-05/bin/linux/amd64/heptio-authenticator-aws
chmod 755 heptio-authenticator-aws
mv heptio-authenticator-aws /usr/bin

yum -y install git bind-utils jq
pip install awscli --upgrade --user
aws configure

clname=`aws eks list-clusters --region us-west-2 | jq .clusters[0] | sed 's/"//g'`
cert=`aws eks describe-cluster --name $clname --query cluster.certificateAuthority.data`
url=`aws eks describe-cluster --name $clname  --query cluster.endpoint`

aws iam create-policy --policy-name myekspolicy  --policy-document file://ekspolicy.json
roleName=`aws iam list-roles | jq .[] | grep MapR600 | grep -v Arn | awk -F\: '{print $2}' | sed 's/["|,]//g'`
policyArn=`aws iam list-policies | grep myeks | grep -v PolicyName | awk -F\:\   '{print $2}' | sed 's/["|,]//g'`
aws iam attach-role-policy --role-name $roleName --policy-arn $policyArn

mkdir -p ~/.kube

cp config /tmp
sed -i s#\<endpoint-url\>#$url#g /tmp/config
sed -i s#\<base64-encoded-ca-cert\>#$cert#g /tmp/config

sed -i s#\<cluster-name\>#$clname#g /tmp/config

cp /tmp/config ~/.kube

